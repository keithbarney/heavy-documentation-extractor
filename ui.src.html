<!DOCTYPE html>
<html>
<head>
  <!-- HEAVY_THEME -->
  <style>
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .preview {
      font-size: 11px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Heavy Documentation Extractor</h1>
    <span class="filename" id="filename">&mdash;</span>
  </div>

  <div class="preview empty" id="preview">Select a Figma Section</div>

  <div class="actions">
    <button class="btn-secondary" id="refresh"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>Refresh</button>
    <button class="btn-secondary" id="copy" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>Copy</button>
    <button class="btn-primary" id="download" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>Download</button>
  </div>

  <div class="status" id="status"></div>

  <div class="support-link">
    <a href="#" id="support-link">Support this plugin &#9829;</a>
  </div>

  <script>
    const SUPPORT_URL = 'https://heavy.lemonsqueezy.com';
    let currentContent = '';
    let currentFilename = 'section.md';

    const preview = document.getElementById('preview');
    const filename = document.getElementById('filename');
    const copyBtn = document.getElementById('copy');
    const downloadBtn = document.getElementById('download');
    const refreshBtn = document.getElementById('refresh');
    const status = document.getElementById('status');

    // Handle messages from plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;

      if (msg?.type === 'markdown') {
        currentContent = msg.content;
        currentFilename = msg.filename;

        preview.textContent = currentContent;
        preview.classList.remove('error', 'empty');
        filename.textContent = currentFilename;

        copyBtn.disabled = false;
        downloadBtn.disabled = false;
        status.textContent = '';
      }

      if (msg?.type === 'error') {
        preview.textContent = msg.message;
        preview.classList.add('empty');
        preview.classList.remove('error');
        filename.textContent = '\u2014';

        copyBtn.disabled = true;
        downloadBtn.disabled = true;
        status.textContent = '';
      }
    };

    // Copy to clipboard using textarea fallback (clipboard API doesn't work in Figma iframes)
    copyBtn.addEventListener('click', () => {
      const textarea = document.createElement('textarea');
      textarea.value = currentContent;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();

      try {
        document.execCommand('copy');
        status.textContent = 'Copied to clipboard';
        status.classList.add('success');
        setTimeout(() => {
          status.textContent = '';
          status.classList.remove('success');
        }, 2000);
      } catch (err) {
        status.textContent = 'Failed to copy';
      }

      document.body.removeChild(textarea);
    });

    // Download file
    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([currentContent], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = currentFilename;
      a.click();
      URL.revokeObjectURL(url);

      status.textContent = 'Downloaded ' + currentFilename;
      status.classList.add('success');
      setTimeout(() => {
        status.textContent = '';
        status.classList.remove('success');
      }, 2000);
    });

    // Refresh
    refreshBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'extract' } }, '*');
    });

    document.getElementById('support-link').addEventListener('click', (e) => {
      e.preventDefault();
      parent.postMessage({ pluginMessage: { type: 'open-url', url: SUPPORT_URL } }, '*');
    });
  </script>
</body>
</html>
